<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exploration Intérieure</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #f8f4e9;
            color: #333;
        }
        .sentiment-honte {
            background-color: #fecaca;
        }
        .sentiment-culpabilite {
            background-color: #bfdbfe;
        }
        .age-0-10 {
            background-color: #581ee0;
            color: white;
        }
        .age-10-20 {
            background-color: #bad810;
        }
        .age-20-30 {
            background-color: #e00dc4;
            color: white;
        }
        .age-30-40 {
            background-color: #e21009;
            color: white;
        }
        .age-40-50 {
            background-color: #2d408f;
            color: white;
        }
        .age-50-plus {
            background-color: #7e7207;
            color: white;
        }
        .domaine-spiritualite {
            background-color: #7e22ce;
            color: white;
        }
        .domaine-mental {
            background-color: #065f46;
            color: white;
        }
        .domaine-professionnel {
            background-color: #1e40af;
            color: white;
        }
        .domaine-financier {
            background-color: #854d0e;
            color: white;
        }
        .domaine-social {
            background-color: #9d174d;
            color: white;
        }
        .domaine-familial {
            background-color: #713f12;
            color: white;
        }
        .domaine-sante {
            background-color: #064e3b;
            color: white;
        }
        .highlight {
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            font-weight: 600;
        }
        .answer-item {
            transition: all 0.3s ease;
        }
        .answer-item:hover {
            transform: translateX(5px);
        }
        .collapse-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .collapse-content.show {
            max-height: 1000px;
            transition: max-height 0.3s ease-in;
        }
        #answer-input {
            min-height: 100px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <header class="bg-amber-900 text-amber-50 py-4 px-6 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
          <div class="flex items-center gap-4">
            <img src="ton-logo.png" alt="Logo" class="h-10 w-auto" />
            <h1 class="text-2xl font-bold">Exploration Intérieure</h1>
          </div>
        </div>
      </header>

    <main class="flex-grow container mx-auto px-4 py-8">
        <!-- Question View -->
        <div id="question-view" class="max-w-3xl mx-auto bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold">Question <span id="current-question-number">1</span>/84</h2>
                <div class="flex items-center">
                    <button id="menu-toggle" class="bg-amber-700 hover:bg-amber-800 text-white px-4 py-2 rounded-lg transition">
                        Menu
                    </button>
                </div>
            </div>

            <div id="question-text" class="text-lg mb-6 leading-relaxed">
                Entre <span id="age-part" class="highlight age-0-10">0-10 ans</span>, dans le domaine  <span id="domain-part" class="highlight domaine-spiritualite">spiritualité</span>, quelles ont été tes expériences de  <span id="sentiment-part" class="highlight sentiment-honte">honte</span> ?
            </div>

            <div class="flex justify-between mb-6">
                <button id="prev-question" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg transition">
                    Question précédente
                </button>
                <button id="next-question" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg transition">
                    Question suivante
                </button>
            </div>

            <!-- Free Answer Mode -->
            <div id="free-answer-mode" class="mb-6">
                <label for="answer-input" class="block text-sm font-medium text-gray-700 mb-2">
                    Votre réponse (Appuyez sur Entrée pour valider, Shift+Entrée pour aller à la ligne)
                </label>
                <textarea id="answer-input"
                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-amber-500 focus:border-amber-500"
                     placeholder="Décrivez votre ressenti... Appuyez sur Entrée pour valider, Shift+Entrée pour aller à la ligne"></textarea>
                <button id="submit-answer"
                      class="mt-2 w-full bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg transition">
                    Valider
                </button>
            </div>

            <!-- Custom Answer Mode (hidden by default) -->
            <div id="custom-answer-mode" class="hidden mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
                <h3 class="text-lg font-medium mb-3">Saisie personnalisée</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label for="custom-sentiment" class="block text-sm font-medium text-gray-700 mb-1">Émotion</label>
                        <select id="custom-sentiment" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            <option value="honte">Honte</option>
                            <option value="culpabilité">Culpabilité</option>
                        </select>
                    </div>
                    <div>
                        <label for="custom-age" class="block text-sm font-medium text-gray-700 mb-1">Tranche d'âge</label>
                        <select id="custom-age" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            <option value="0-10 ans">0-10 ans</option>
                            <option value="10-20 ans">10-20 ans</option>
                            <option value="20-30 ans">20-30 ans</option>
                            <option value="30-40 ans">30-40 ans</option>
                            <option value="40-50 ans">40-50 ans</option>
                            <option value="50 ans et plus">50 ans et plus</option>
                        </select>
                    </div>
                    <div>
                        <label for="custom-domain" class="block text-sm font-medium text-gray-700 mb-1">Domaine de vie</label>
                        <select id="custom-domain" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            <option value="spiritualite" class="bg-purple-700 text-white">Spiritualite</option>
                            <option value="mental/psychologie" class="bg-emerald-800 text-white">Mental/Psychologie</option>
                            <option value="professionnel" class="bg-blue-800 text-white">Professionnel</option>
                            <option value="financier" class="bg-yellow-800 text-white">Financier</option>
                            <option value="social" class="bg-pink-800 text-white">Social</option>
                            <option value="familial" class="bg-amber-800 text-white">Familial et couple</option>
                            <option value="sante" class="bg-teal-800 text-white">Sante et physique</option>
                        </select>
                    </div>
                </div>
                <textarea id="custom-answer-input"
                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-amber-500 focus:border-amber-500"
                     placeholder="Décrivez votre ressenti..."></textarea>
                <div class="flex justify-end mt-2">
                    <button id="submit-custom-answer"
                          class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg transition">
                        Ajouter cette réponse
                    </button>
                </div>
            </div>

            <div class="flex justify-between mb-4">
                <button id="toggle-answer-mode" class="text-amber-700 hover:text-amber-900 text-sm font-medium">
                    Mode de saisie personnalisée
                </button>
            </div>

            <div id="answers-list" class="mb-6">
                <h3 class="text-sm font-medium text-gray-700 mb-2">Réponses (<span id="answers-count">0</span>)</h3>
                <div id="answers-container" class="space-y-2"></div>
            </div>
        </div>

        <!-- Menu View (hidden by default) -->
        <div id="menu-view" class="hidden max-w-3xl mx-auto bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold">Menu</h2>
                <button id="close-menu" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg transition">
                    Retour aux questions
                </button>
            </div>

            <div class="mb-6">
                <h3 class="text-lg font-medium mb-3">Navigation</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                    <button data-view="all-answers" class="bg-gray-100 hover:bg-gray-200 text-gray-800 px-4 py-2 rounded-lg transition w-full text-left">
                        Voir toutes mes réponses
                    </button>
                    <button data-view="export" class="bg-gray-100 hover:bg-gray-200 text-gray-800 px-4 py-2 rounded-lg transition w-full text-left">
                        Exporter mes réponses
                    </button>
                    <button data-view="import" class="bg-gray-100 hover:bg-gray-200 text-gray-800 px-4 py-2 rounded-lg transition w-full text-left">
                        Importer des réponses
                    </button>
                </div>
            </div>

            <div class="mb-6">
                <h3 class="text-lg font-medium mb-3">Liste des questions</h3>
                <div class="overflow-y-auto max-h-96 border border-gray-200 rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">#</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Âge</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Domaine</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Émotion</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Réponses</th>
                            </tr>
                        </thead>
                        <tbody id="questions-list" class="bg-white divide-y divide-gray-200">
                            <!-- Questions will be populated here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- All Answers View (hidden by default) -->
        <div id="all-answers-view" class="hidden max-w-3xl mx-auto bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold">Toutes mes réponses</h2>
                <button data-view="menu" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg transition">
                    Retour au menu
                </button>
            </div>

            <div id="all-answers-container" class="space-y-4">
                <!-- All answers will be populated here by JavaScript -->
            </div>
        </div>

        <!-- Export View (hidden by default) -->
        <div id="export-view" class="hidden max-w-3xl mx-auto bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold">Exporter mes réponses</h2>
                <button data-view="menu" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg transition">
                    Retour au menu
                </button>
            </div>

            <div class="mb-4">
                <p class="text-gray-700 mb-4">Vous pouvez exporter toutes vos réponses au format CSV pour les sauvegarder ou les partager.</p>
                <button id="export-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition">
                    Exporter vers CSV
                </button>
            </div>

            <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                <label for="export-content" class="block text-sm font-medium text-gray-700 mb-2">Contenu exporté</label>
                <textarea id="export-content" rows="10" class="w-full px-3 py-2 border border-gray-300 rounded-md" readonly></textarea>
                <button id="copy-export" class="mt-2 bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg transition">
                    Copier le texte
                </button>
            </div>
        </div>

        <!-- Import View (hidden by default) -->
        <div id="import-view" class="hidden max-w-3xl mx-auto bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold">Importer des réponses</h2>
                <button data-view="menu" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg transition">
                    Retour au menu
                </button>
            </div>

            <div class="mb-4">
                <p class="text-gray-700 mb-4">Vous pouvez importer des réponses à partir d'un fichier CSV précédemment exporté.</p>
                <input type="file" id="import-file" class="hidden" accept=".csv">
                <button id="select-file-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
                    Sélectionner un fichier
                </button>
                <span id="selected-file-name" class="ml-3 text-gray-600">Aucun fichier sélectionné</span>
            </div>

            <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                <label for="import-content" class="block text-sm font-medium text-gray-700 mb-2">Ou coller directement le contenu CSV ici</label>
                <textarea id="import-content" rows="10" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Collez ici le contenu CSV..."></textarea>
                <button id="import-btn" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
                    Importer les réponses
                </button>
            </div>
        </div>

        <!-- Completion View (hidden by default) -->
        <div id="completion-view" class="hidden max-w-3xl mx-auto bg-white rounded-lg shadow-md p-6 mb-8 text-center">
            <div class="mb-6">
                <svg class="w-16 h-16 text-green-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
            <h2 class="text-2xl font-semibold mb-4">Félicitations !</h2>
            <p class="text-lg mb-6">Vous avez terminé toutes les questions de cette exploration intérieure.</p>
            <p class="mb-6">Nous vous encourageons à exporter vos réponses pour les conserver ou les partager avec un professionnel si vous le souhaitez.</p>
            <button data-view="export" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg transition text-lg">
                Exporter mes réponses
            </button>
        </div>
    </main>

    <footer class="bg-amber-900 text-amber-50 py-4 px-6 text-center text-sm">
        <p>Exploration Intérieure - Un outil pour mieux se connaître</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Data structure
            const sentiments = ["honte", "culpabilité"];
            const ages = ["0-10 ans", "10-20 ans", "20-30 ans", "30-40 ans", "40-50 ans", "50 ans et plus"];
            const domains = ["spiritualite", "mental/psychologie", "professionnel", "financier", "social", "familial", "sante"];
            
            // Generate all questions
            let questions = [];
            ages.forEach(age => {
                domains.forEach(domain => {
                    sentiments.forEach(sentiment => {
                        questions.push({ age, domain, sentiment, answers: [] });
                    });
                });
            });

            // Current question index
            let currentQuestionIndex = 0;
            let userAuthenticated = false;

            // DOM elements
            const questionView = document.getElementById('question-view');
            const menuView = document.getElementById('menu-view');
            const allAnswersView = document.getElementById('all-answers-view');
            const exportView = document.getElementById('export-view');
            const importView = document.getElementById('import-view');
            const completionView = document.getElementById('completion-view');

            const currentQuestionNumber = document.getElementById('current-question-number');
            const sentimentPart = document.getElementById('sentiment-part');
            const agePart = document.getElementById('age-part');
            const domainPart = document.getElementById('domain-part');

            const answerInput = document.getElementById('answer-input');
            const submitAnswer = document.getElementById('submit-answer');
            const answersContainer = document.getElementById('answers-container');
            const answersCount = document.getElementById('answers-count');

            const prevQuestion = document.getElementById('prev-question');
            const nextQuestion = document.getElementById('next-question');

            const menuToggle = document.getElementById('menu-toggle');
            const closeMenu = document.getElementById('close-menu');

            const questionsList = document.getElementById('questions-list');
            const allAnswersContainer = document.getElementById('all-answers-container');

            const exportBtn = document.getElementById('export-btn');
            const exportContent = document.getElementById('export-content');
            const copyExport = document.getElementById('copy-export');

            const importFile = document.getElementById('import-file');
            const selectFileBtn = document.getElementById('select-file-btn');
            const selectedFileName = document.getElementById('selected-file-name');
            const importContent = document.getElementById('import-content');
            const importBtn = document.getElementById('import-btn');

            // Custom answer mode elements
            const freeAnswerMode = document.getElementById('free-answer-mode');
            const customAnswerMode = document.getElementById('custom-answer-mode');
            const toggleAnswerMode = document.getElementById('toggle-answer-mode');
            const customSentiment = document.getElementById('custom-sentiment');
            const customAge = document.getElementById('custom-age');
            const customDomain = document.getElementById('custom-domain');
            const customAnswerInput = document.getElementById('custom-answer-input');
            const submitCustomAnswer = document.getElementById('submit-custom-answer');

            // Initialize the app
            function init() {
                // Load saved data from localStorage
                const savedData = localStorage.getItem('introspectionAppData');
                if (savedData) {
                    try {
                        const parsedData = JSON.parse(savedData);
                        if (parsedData.questions) {
                            // Merge the saved answers with our questions structure
                            parsedData.questions.forEach((savedQuestion, index) => {
                                if (questions[index] && savedQuestion.answers) {
                                    questions[index].answers = savedQuestion.answers;
                                }
                            });
                        }
                        currentQuestionIndex = parsedData.currentQuestionIndex || 0;
                    } catch (e) {
                        console.error("Error parsing saved data:", e);
                    }
                }

                // Display the current question
                displayQuestion(currentQuestionIndex);

                // Set up event listeners
                setupEventListeners();

                // Populate questions list for navigation
                populateQuestionsList();
            }

            // Set up event listeners
            function setupEventListeners() {
                // Navigation buttons
                prevQuestion.addEventListener('click', () => navigateQuestions(-1));
                nextQuestion.addEventListener('click', () => navigateQuestions(1));

                // Answer submission
                submitAnswer.addEventListener('click', addAnswer);
                answerInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        addAnswer();
                    }
                });

                // Custom answer submission
                submitCustomAnswer.addEventListener('click', addCustomAnswer);
                customAnswerInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        addCustomAnswer();
                    }
                });

                // Toggle answer mode
                toggleAnswerMode.addEventListener('click', function() {
                    if (customAnswerMode.classList.contains('hidden')) {
                        freeAnswerMode.classList.add('hidden');
                        customAnswerMode.classList.remove('hidden');
                        toggleAnswerMode.textContent = 'Mode de saisie standard';
                    } else {
                        freeAnswerMode.classList.remove('hidden');
                        customAnswerMode.classList.add('hidden');
                        toggleAnswerMode.textContent = 'Mode de saisie personnalisée';
                    }
                });

                // Menu navigation
                menuToggle.addEventListener('click', () => {
                    questionView.classList.add('hidden');
                    menuView.classList.remove('hidden');
                    populateQuestionsList(); // Refresh the list when opening menu
                });

                closeMenu.addEventListener('click', () => {
                    menuView.classList.add('hidden');
                    questionView.classList.remove('hidden');
                });

                // View navigation buttons
                document.querySelectorAll('[data-view]').forEach(button => {
                    button.addEventListener('click', function() {
                        const targetView = this.getAttribute('data-view');
                        navigateToView(targetView);
                    });
                });

                // Export functionality
                exportBtn.addEventListener('click', exportAnswers);
                copyExport.addEventListener('click', copyExportContent);

                // Import functionality
                selectFileBtn.addEventListener('click', () => importFile.click());
                importFile.addEventListener('change', handleFileSelect);
                importBtn.addEventListener('click', importAnswers);
            }

            // Navigate between views
            function navigateToView(viewName) {
                // Hide all views
                questionView.classList.add('hidden');
                menuView.classList.add('hidden');
                allAnswersView.classList.add('hidden');
                exportView.classList.add('hidden');
                importView.classList.add('hidden');
                completionView.classList.add('hidden');

                // Show the target view
                switch(viewName) {
                    case 'question':
                        questionView.classList.remove('hidden');
                        break;
                    case 'menu':
                        menuView.classList.remove('hidden');
                        populateQuestionsList(); // Refresh the list when opening menu
                        break;
                    case 'all-answers':
                        allAnswersView.classList.remove('hidden');
                        displayAllAnswers();
                        break;
                    case 'export':
                        exportView.classList.remove('hidden');
                        prepareExportContent();
                        break;
                    case 'import':
                        importView.classList.remove('hidden');
                        break;
                    default:
                        questionView.classList.remove('hidden');
                }
            }

            // Display a question by index
            function displayQuestion(index) {
                if (index < 0 || index >= questions.length) return;

                currentQuestionIndex = index;
                const question = questions[index];

                // Update question number
                currentQuestionNumber.textContent = index + 1;

                // Update question text with highlighted parts
                sentimentPart.textContent = question.sentiment;
                agePart.textContent = question.age;
                domainPart.textContent = (question.domain === 'sante') ? 'santé/physique' : (question.domain === 'familial') ? 'familial/couple' : question.domain;

                // Update highlight classes
                sentimentPart.className = `highlight sentiment-${question.sentiment === 'honte' ? 'honte' : 'culpabilite'}`;

                // Corrected age class names
                let ageClass = '';
                if (question.age === '0-10 ans') ageClass = 'age-0-10';
                else if (question.age === '10-20 ans') ageClass = 'age-10-20';
                else if (question.age === '20-30 ans') ageClass = 'age-20-30';
                else if (question.age === '30-40 ans') ageClass = 'age-30-40';
                else if (question.age === '40-50 ans') ageClass = 'age-40-50';
                else if (question.age === '50 ans et plus') ageClass = 'age-50-plus';

                agePart.className = `highlight ${ageClass}`;

                // Domain class
                const domainClass = `domaine-${question.domain.split('/')[0].replace(' ', '-')}`;
                domainPart.className = `highlight ${domainClass}`;

                // Display answers
                displayAnswers(question.answers);

                // Update navigation buttons
                prevQuestion.disabled = index === 0;
                nextQuestion.disabled = index === questions.length - 1;

                // Save current state
                saveData();
            }

            // Display answers for the current question in reverse chronological order
            function displayAnswers(answers) {
                answersContainer.innerHTML = '';
                answersCount.textContent = answers.length;

                if (answers.length === 0) {
                    answersContainer.innerHTML = '<p class="text-gray-500 italic">Aucune réponse pour cette question</p>';
                    return;
                }

                // Sort answers by timestamp (newest first)
                const sortedAnswers = [...answers].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                sortedAnswers.forEach((answer, i) => {
                    const answerElement = document.createElement('div');
                    answerElement.className = 'answer-item bg-gray-50 p-3 rounded-lg flex justify-between items-center';
                    answerElement.innerHTML = `
                        <div class="flex-grow whitespace-pre-line">${answer.text}</div>
                        <div class="flex space-x-2">
                            <button class="edit-answer text-blue-600 hover:text-blue-800" data-index="${answers.indexOf(answer)}">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </button>
                            <button class="delete-answer text-red-600 hover:text-red-800" data-index="${answers.indexOf(answer)}">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    `;
                    answersContainer.appendChild(answerElement);
                });

                // Add event listeners for answer actions
                document.querySelectorAll('.edit-answer').forEach(button => {
                    button.addEventListener('click', function() {
                        const answerIndex = parseInt(this.getAttribute('data-index'));
                        editAnswer(answerIndex);
                    });
                });

                document.querySelectorAll('.delete-answer').forEach(button => {
                    button.addEventListener('click', function() {
                        const answerIndex = parseInt(this.getAttribute('data-index'));
                        deleteAnswer(answerIndex);
                    });
                });
            }

            // Add a new answer
            function addAnswer() {
                const answerText = answerInput.value.trim();
                if (!answerText) return;

                const question = questions[currentQuestionIndex];
                question.answers.push({
                    text: answerText,
                    timestamp: new Date().toISOString()
                });

                // Clear input
                answerInput.value = '';

                // Update display
                displayAnswers(question.answers);
                populateQuestionsList(); // Update the questions list count

                // Save data
                saveData();
            }

            // Add a custom answer
            function addCustomAnswer() {
                const answerText = customAnswerInput.value.trim();
                if (!answerText) return;

                const sentiment = customSentiment.value;
                const age = customAge.value;
                const domain = customDomain.value;

                // Find the question index
                const questionIndex = questions.findIndex(q => 
                    q.sentiment === sentiment &&
                    q.age === age &&
                    q.domain === domain
                );

                if (questionIndex !== -1) {
                    questions[questionIndex].answers.push({
                        text: answerText,
                        timestamp: new Date().toISOString()
                    });

                    // Clear input
                    customAnswerInput.value = '';

                    // If we're currently viewing this question, update the display
                    if (currentQuestionIndex === questionIndex) {
                        displayAnswers(questions[questionIndex].answers);
                    }

                    // Update the questions list count
                    populateQuestionsList();

                    // Save data
                    saveData();

                    // Show success message
                    alert(`Réponse ajoutée à la question: ${sentiment} (${age}, ${domain})`);
                } else {
                    alert('Question non trouvée');
                }
            }

            // Edit an answer
            function editAnswer(answerIndex) {
                const question = questions[currentQuestionIndex];
                const answer = question.answers[answerIndex];

                const newText = prompt("Modifier votre réponse:", answer.text);
                if (newText !== null && newText.trim() !== '') {
                    answer.text = newText.trim();
                    answer.timestamp = new Date().toISOString();
                    displayAnswers(question.answers);
                    saveData();
                }
            }

            // Delete an answer
            function deleteAnswer(answerIndex) {
                if (confirm("Êtes-vous sûr de vouloir supprimer cette réponse ?")) {
                    const question = questions[currentQuestionIndex];
                    question.answers.splice(answerIndex, 1);
                    displayAnswers(question.answers);
                    populateQuestionsList(); // Update the questions list count
                    saveData();
                }
            }

            // Navigate between questions
            function navigateQuestions(direction) {
                const newIndex = currentQuestionIndex + direction;
                if (newIndex >= 0 && newIndex < questions.length) {
                    displayQuestion(newIndex);

                    // Check if we've completed all questions
                    if (newIndex === questions.length - 1 && direction === 1) {
                        checkCompletion();
                    }
                }
            }

            // Check if all questions are completed
            function checkCompletion() {
                const allAnswered = questions.every(q => q.answers.length > 0);
                if (allAnswered) {
                    setTimeout(() => {
                        questionView.classList.add('hidden');
                        completionView.classList.remove('hidden');
                    }, 1000);
                }
            }

            // Populate questions list for navigation
            function populateQuestionsList() {
                questionsList.innerHTML = '';

                questions.forEach((question, index) => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 cursor-pointer';

                    // Determine age class
                    let ageClass = '';
                    if (question.age === '0-10 ans') ageClass = 'age-0-10';
                    else if (question.age === '10-20 ans') ageClass = 'age-10-20';
                    else if (question.age === '20-30 ans') ageClass = 'age-20-30';
                    else if (question.age === '30-40 ans') ageClass = 'age-30-40';
                    else if (question.age === '40-50 ans') ageClass = 'age-40-50';
                    else if (question.age === '50 ans et plus') ageClass = 'age-50-plus';

                    // Determine domain class
                    const domainClass = `domaine-${question.domain.split('/')[0].replace(' ', '-')}`;

                    row.innerHTML = `
                        <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${index + 1}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm">
                            <span class="${ageClass} px-1 rounded">${question.age}</span>
                        </td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm">
                            <span class="${domainClass} px-1 rounded">${question.domain}</span>
                        </td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm">
                            <span class="${question.sentiment === 'honte' ? 'sentiment-honte' : 'sentiment-culpabilite'} px-1 rounded">${question.sentiment}</span>
                        </td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${question.answers.length}</td>
                    `;

                    row.addEventListener('click', () => {
                        displayQuestion(index);
                        menuView.classList.add('hidden');
                        questionView.classList.remove('hidden');
                    });

                    questionsList.appendChild(row);
                });
            }

            // Display all answers in the all answers view with collapsible sections
            function displayAllAnswers() {
                allAnswersContainer.innerHTML = '';

                // Filter questions that have answers
                const answeredQuestions = questions.filter(q => q.answers.length > 0);

                if (answeredQuestions.length === 0) {
                    allAnswersContainer.innerHTML = '<p class="text-gray-500 italic">Vous n\'avez pas encore répondu à aucune question.</p>';
                    return;
                }

                answeredQuestions.forEach((question, index) => {
                    const questionIndex = questions.findIndex(q => 
                        q.sentiment === question.sentiment &&
                        q.age === question.age &&
                        q.domain === question.domain
                    );

                    const questionBlock = document.createElement('div');
                    questionBlock.className = 'border border-gray-200 rounded-lg overflow-hidden';

                    // Create the collapsible header
                    const header = document.createElement('div');
                    header.className = 'bg-gray-100 p-4 flex justify-between items-center cursor-pointer';

                    // Determine age class
                    let ageClass = '';
                    if (question.age === '0-10 ans') ageClass = 'age-0-10';
                    else if (question.age === '10-20 ans') ageClass = 'age-10-20';
                    else if (question.age === '20-30 ans') ageClass = 'age-20-30';
                    else if (question.age === '30-40 ans') ageClass = 'age-30-40';
                    else if (question.age === '40-50 ans') ageClass = 'age-40-50';
                    else if (question.age === '50 ans et plus') ageClass = 'age-50-plus';

                    // Determine domain class
                    const domainClass = `domaine-${question.domain.split('/')[0].replace(' ', '-')}`;

                    header.innerHTML = `
                        <div>
                            <h3 class="font-medium">
                                Question ${questionIndex + 1}: 
                                <span class="${ageClass} px-1 rounded">${question.age}</span>
                                <span class="${domainClass} px-1 rounded">${question.domain}</span>
                                <span class="${question.sentiment === 'honte' ? 'sentiment-honte' : 'sentiment-culpabilite'} px-1 rounded">${question.sentiment}</span>
                            </h3>
                            <p class="text-sm text-gray-600 mt-1">${question.answers.length} réponse(s)</p>
                        </div>
                        <svg class="w-5 h-5 text-gray-500 transition-transform duration-300 transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    `;

                    // Create the collapsible content
                    const content = document.createElement('div');
                    content.className = 'collapse-content bg-white';
                    content.innerHTML = `
                        <div class="p-4 space-y-3">
                            ${question.answers.map((answer, i) => `
                                <div class="bg-gray-50 p-3 rounded-lg flex justify-between items-center">
                                    <div class="whitespace-pre-line">${answer.text}</div>
                                    <div class="flex space-x-2">
                                        <button class="edit-all-answer text-blue-600 hover:text-blue-800" data-question="${questionIndex}" data-index="${i}">
                                            <svg class="w-5 h-5" fill="none stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                            </svg>
                                        </button>
                                        <button class="delete-all-answer text-red-600 hover:text-red-800" data-question="${questionIndex}" data-index="${i}">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="p-4 border-t border-gray-200">
                            <div class="flex">
                                <input type="text" id="new-answer-${questionIndex}" 
                                     class="flex-grow px-4 py-2 border border-gray-300 rounded-l-lg focus:ring-amber-500 focus:border-amber-500" 
                                     placeholder="Ajouter une réponse...">
                                <button class="add-answer-btn bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-r-lg transition"
                                    data-question="${questionIndex}">
                                    Ajouter
                                </button>
                            </div>
                        </div>
                    `;

                    // Toggle collapse on header click
                    header.addEventListener('click', () => {
                        const icon = header.querySelector('svg');
                        content.classList.toggle('show');
                        icon.classList.toggle('rotate-180');
                    });

                    questionBlock.appendChild(header);
                    questionBlock.appendChild(content);
                    allAnswersContainer.appendChild(questionBlock);
                });

                // Add event listeners for answer actions in all answers view
                document.querySelectorAll('.edit-all-answer').forEach(button => {
                    button.addEventListener('click', function() {
                        const questionIndex = parseInt(this.getAttribute('data-question'));
                        const answerIndex = parseInt(this.getAttribute('data-index'));
                        editAnswerInAllView(questionIndex, answerIndex);
                    });
                });

                document.querySelectorAll('.delete-all-answer').forEach(button => {
                    button.addEventListener('click', function() {
                        const questionIndex = parseInt(this.getAttribute('data-question'));
                        const answerIndex = parseInt(this.getAttribute('data-index'));
                        deleteAnswerInAllView(questionIndex, answerIndex);
                    });
                });

                document.querySelectorAll('.add-answer-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const questionIndex = parseInt(this.getAttribute('data-question'));
                        const input = document.getElementById(`new-answer-${questionIndex}`);
                        const answerText = input.value.trim();

                        if (answerText) {
                            questions[questionIndex].answers.push({
                                text: answerText,
                                timestamp: new Date().toISOString()
                            });

                            input.value = '';
                            saveData();
                            displayAllAnswers();
                        }
                    });
                });
            }

            // Edit answer in all answers view
            function editAnswerInAllView(questionIndex, answerIndex) {
                const answer = questions[questionIndex].answers[answerIndex];

                const newText = prompt("Modifier votre réponse:", answer.text);
                if (newText !== null && newText.trim() !== '') {
                    answer.text = newText.trim();
                    answer.timestamp = new Date().toISOString();
                    saveData();
                    displayAllAnswers();
                }
            }

            // Delete answer in all answers view
            function deleteAnswerInAllView(questionIndex, answerIndex) {
                if (confirm("Êtes-vous sûr de vouloir supprimer cette réponse ?")) {
                    questions[questionIndex].answers.splice(answerIndex, 1);
                    saveData();
                    displayAllAnswers();
                }
            }

            // Prepare export content
            function prepareExportContent() {
                const csvRows = [];

                // Add header row
                csvRows.push(['Question', 'Sentiment', 'Période', 'Domaine', 'Réponse', 'Date'].join(','));

                // Add data rows
                questions.forEach((question, index) => {
                    if (question.answers.length === 0) {
                        csvRows.push([
                            index + 1,
                            question.sentiment,
                            question.age,
                            question.domain,
                            '',
                            ''
                        ].join(','));
                    } else {
                        question.answers.forEach(answer => {
                            csvRows.push([
                                index + 1,
                                question.sentiment,
                                question.age,
                                question.domain,
                                `"${answer.text.replace(/"/g, '""')}"`,
                                answer.timestamp
                            ].join(','));
                        });
                    }
                });

                exportContent.value = csvRows.join('\n');
            }

            // Export answers to CSV
            function exportAnswers() {
                prepareExportContent();

                const blob = new Blob([exportContent.value], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `exploration-interieure-${new Date().toISOString().slice(0, 10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            // Copy export content to clipboard
            function copyExportContent() {
                exportContent.select();
                document.execCommand('copy');

                // Show feedback
                const originalText = copyExport.textContent;
                copyExport.textContent = 'Copié !';
                setTimeout(() => {
                    copyExport.textContent = originalText;
                }, 2000);
            }

            // Handle file selection for import
            function handleFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;

                selectedFileName.textContent = file.name;

                const reader = new FileReader();
                reader.onload = function(e) {
                    importContent.value = e.target.result;
                };
                reader.readAsText(file);
            }

            // Import answers from CSV
            function importAnswers() {
                const csvData = importContent.value.trim();
                if (!csvData) {
                    alert('Veuillez coller ou sélectionner un fichier CSV à importer.');
                    return;
                }

                if (confirm('Cette action remplacera toutes vos réponses actuelles. Continuer ?')) {
                    try {
                        // Parse CSV
                        const lines = csvData.split('\n');
                        const headers = lines[0].split(',');

                        // Reset all answers
                        questions.forEach(q => q.answers = []);

                        // Process data rows
                        for (let i = 1; i < lines.length; i++) {
                            const values = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);

                            if (values.length >= 6) {
                                const questionIndex = parseInt(values[0]) - 1;
                                const answerText = values[4].replace(/^"|"$/g, '').replace(/""/g, '"');
                                const timestamp = values[5] || new Date().toISOString();

                                if (questionIndex >= 0 && questionIndex < questions.length && answerText) {
                                    questions[questionIndex].answers.push({
                                        text: answerText,
                                        timestamp: timestamp
                                    });
                                }
                            }
                        }

                        // Save and refresh
                        saveData();
                        displayQuestion(currentQuestionIndex);
                        populateQuestionsList();

                        alert('Importation réussie !');
                        navigateToView('menu');
                    } catch (error) {
                        console.error('Error importing CSV:', error);
                        alert('Une erreur est survenue lors de l\'importation. Vérifiez le format du fichier.');
                    }
                }
            }

            // Save data to localStorage
            function saveData() {
                const data = {
                    questions,
                    currentQuestionIndex
                };

                localStorage.setItem('introspectionAppData', JSON.stringify(data));
            }

            // Initialize the application
            init();
        });
    </script>
</body>
</html>